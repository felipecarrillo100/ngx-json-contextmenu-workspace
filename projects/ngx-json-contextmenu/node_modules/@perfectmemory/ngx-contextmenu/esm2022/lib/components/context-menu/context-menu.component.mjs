import { ComponentPortal } from '@angular/cdk/portal';
import { Component, ContentChildren, ElementRef, EventEmitter, Input, Output, ViewEncapsulation, } from '@angular/core';
import { Subscription } from 'rxjs';
import { ContextMenuItemDirective } from '../../directives/context-menu-item/context-menu-item.directive';
import { evaluateIfFunction } from '../../helper/evaluate';
import { ContextMenuContentComponent } from '../context-menu-content/context-menu-content.component';
import { getPositionsToAnchorElement, getPositionsToXY, } from './context-menu.component.helpers';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
import * as i2 from "../../services/context-menu-stack/context-menu-stack.service";
import * as i3 from "../../services/context-menu-event/context-menu-event.service";
export class ContextMenuComponent {
    constructor(overlay, scrollStrategy, contextMenuStack, contextMenuEventService) {
        this.overlay = overlay;
        this.scrollStrategy = scrollStrategy;
        this.contextMenuStack = contextMenuStack;
        this.contextMenuEventService = contextMenuEventService;
        /**
         * A CSS class to apply to the context menu overlay, ideal for theming and custom styling
         */
        this.menuClass = '';
        /**
         * Disable the whole context menu
         */
        this.disabled = false;
        /**
         * Emit when the menu is opened
         */
        this.open = new EventEmitter();
        /**
         * Emit when the menu is closed
         */
        this.close = new EventEmitter();
        /**
         * @internal
         */
        this.visibleMenuItems = [];
        this.subscription = new Subscription();
    }
    /**
     * @internal
     */
    ngOnInit() {
        const subscription = this.contextMenuEventService.onShow.subscribe((menuEvent) => {
            this.onMenuEvent(menuEvent);
        });
        this.subscription.add(subscription);
    }
    /**
     * @internal
     */
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
    /**
     * Open context menu
     */
    openContextMenu(context) {
        let positionStrategy;
        if (context.anchoredTo === 'position') {
            positionStrategy = this.overlay
                .position()
                .flexibleConnectedTo({
                x: context.x,
                y: context.y,
            })
                .withPositions(getPositionsToXY(context.dir));
            this.closeAllContextMenus();
        }
        else {
            const { anchorElement, parentContextMenu } = context;
            positionStrategy = this.overlay
                .position()
                .flexibleConnectedTo(new ElementRef(anchorElement))
                .withPositions(getPositionsToAnchorElement(parentContextMenu.dir));
            this.contextMenuStack.destroySubMenus(parentContextMenu);
        }
        const overlayRef = this.overlay.create({
            positionStrategy,
            panelClass: 'ngx-contextmenu',
            scrollStrategy: this.scrollStrategy.close(),
        });
        this.attachContextMenu(overlayRef, context);
    }
    onMenuEvent(event) {
        if (this.disabled) {
            return;
        }
        const { contextMenu, value } = event;
        if (contextMenu && contextMenu !== this) {
            return;
        }
        this.value = value;
        this.setVisibleMenuItems();
        this.openContextMenu({
            ...event,
            menuItemDirectives: this.visibleMenuItems,
            menuClass: this.menuClass,
            dir: this.dir,
        });
        this.open.next(event);
    }
    attachContextMenu(overlayRef, context) {
        const { value, menuItemDirectives } = context;
        const contextMenuContentRef = overlayRef.attach(new ComponentPortal(ContextMenuContentComponent));
        const { instance: contextMenuContentComponent } = contextMenuContentRef;
        contextMenuContentComponent.value = value;
        contextMenuContentComponent.menuDirectives = menuItemDirectives;
        contextMenuContentComponent.overlayRef = overlayRef;
        contextMenuContentComponent.isLeaf = true;
        contextMenuContentComponent.menuClass = this.getMenuClass(context);
        contextMenuContentComponent.dir = this.getDir(context);
        this.contextMenuStack.push({
            overlayRef,
            contextMenuContentComponent,
        });
        const subscriptions = new Subscription();
        subscriptions.add(contextMenuContentComponent.execute.subscribe(() => this.closeAllContextMenus()));
        subscriptions.add(contextMenuContentComponent.closeAllMenus.subscribe(() => this.closeAllContextMenus()));
        subscriptions.add(contextMenuContentComponent.closeLeafMenu.subscribe((closeLeafMenuEvent) => this.destroyLeafMenu(!!closeLeafMenuEvent.excludeRootMenu)));
        subscriptions.add(contextMenuContentComponent.openSubMenu.subscribe((openSubMenuEvent) => {
            this.contextMenuStack.destroySubMenus(contextMenuContentComponent);
            if (!openSubMenuEvent.contextMenu) {
                contextMenuContentComponent.isLeaf = true;
                return;
            }
            contextMenuContentComponent.isLeaf = false;
            this.contextMenuEventService.show(openSubMenuEvent);
        }));
        subscriptions.add(contextMenuContentComponent.closeSubMenus.subscribe(() => {
            this.contextMenuStack.destroySubMenus(contextMenuContentComponent);
        }));
        contextMenuContentRef.onDestroy(() => {
            this.close.next();
            menuItemDirectives.forEach((menuItem) => (menuItem.isActive = false));
            subscriptions.unsubscribe();
        });
        contextMenuContentRef.changeDetectorRef.detectChanges();
    }
    getMenuClass(event) {
        return (event.menuClass ||
            (event.anchoredTo === 'element' && event?.parentContextMenu?.menuClass) ||
            '');
    }
    getDir(event) {
        return (event.dir ||
            (event.anchoredTo === 'element' && event?.parentContextMenu?.dir) ||
            undefined);
    }
    closeAllContextMenus() {
        this.contextMenuStack.closeAll();
    }
    destroyLeafMenu(excludeRootMenu) {
        this.contextMenuStack.closeLeafMenu(excludeRootMenu);
    }
    isMenuItemVisible(menuItem) {
        return evaluateIfFunction(menuItem.visible, this.value);
    }
    setVisibleMenuItems() {
        this.visibleMenuItems = this.menuItems.filter((menuItem) => this.isMenuItemVisible(menuItem));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: ContextMenuComponent, deps: [{ token: i1.Overlay }, { token: i1.ScrollStrategyOptions }, { token: i2.ContextMenuStackService }, { token: i3.ContextMenuEventService }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.0.0", type: ContextMenuComponent, selector: "context-menu", inputs: { menuClass: "menuClass", disabled: "disabled", dir: "dir" }, outputs: { open: "open", close: "close" }, queries: [{ propertyName: "menuItems", predicate: ContextMenuItemDirective }], ngImport: i0, template: '', isInline: true, encapsulation: i0.ViewEncapsulation.None }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: ContextMenuComponent, decorators: [{
            type: Component,
            args: [{
                    encapsulation: ViewEncapsulation.None,
                    selector: 'context-menu',
                    template: '',
                }]
        }], ctorParameters: function () { return [{ type: i1.Overlay }, { type: i1.ScrollStrategyOptions }, { type: i2.ContextMenuStackService }, { type: i3.ContextMenuEventService }]; }, propDecorators: { menuClass: [{
                type: Input
            }], disabled: [{
                type: Input
            }], dir: [{
                type: Input
            }], open: [{
                type: Output
            }], close: [{
                type: Output
            }], menuItems: [{
                type: ContentChildren,
                args: [ContextMenuItemDirective]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1jb250ZXh0bWVudS9zcmMvbGliL2NvbXBvbmVudHMvY29udGV4dC1tZW51L2NvbnRleHQtbWVudS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFDTCxTQUFTLEVBQ1QsZUFBZSxFQUNmLFVBQVUsRUFDVixZQUFZLEVBQ1osS0FBSyxFQUVMLE1BQU0sRUFFTixpQkFBaUIsR0FDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwQyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxnRUFBZ0UsQ0FBQztBQUMxRyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUczRCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUNyRyxPQUFPLEVBQ0wsMkJBQTJCLEVBQzNCLGdCQUFnQixHQUNqQixNQUFNLGtDQUFrQyxDQUFDOzs7OztBQVcxQyxNQUFNLE9BQU8sb0JBQW9CO0lBZ0QvQixZQUNVLE9BQWdCLEVBQ2hCLGNBQXFDLEVBQ3JDLGdCQUE0QyxFQUM1Qyx1QkFBbUQ7UUFIbkQsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUNoQixtQkFBYyxHQUFkLGNBQWMsQ0FBdUI7UUFDckMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUE0QjtRQUM1Qyw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQTRCO1FBbkQ3RDs7V0FFRztRQUVJLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFFdEI7O1dBRUc7UUFFSSxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBUXhCOztXQUVHO1FBRUksU0FBSSxHQUEwQyxJQUFJLFlBQVksRUFB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QUFTO3NCQURmLGVBQWU7dUJBQUMsd0JBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRmxleGlibGVDb25uZWN0ZWRQb3NpdGlvblN0cmF0ZWd5LFxuICBPdmVybGF5LFxuICBPdmVybGF5UmVmLFxuICBTY3JvbGxTdHJhdGVneU9wdGlvbnMsXG59IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wb3J0YWwnO1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGRyZW4sXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBRdWVyeUxpc3QsXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQ29udGV4dE1lbnVJdGVtRGlyZWN0aXZlIH0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcy9jb250ZXh0LW1lbnUtaXRlbS9jb250ZXh0LW1lbnUtaXRlbS5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgZXZhbHVhdGVJZkZ1bmN0aW9uIH0gZnJvbSAnLi4vLi4vaGVscGVyL2V2YWx1YXRlJztcbmltcG9ydCB7IENvbnRleHRNZW51RXZlbnRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvY29udGV4dC1tZW51LWV2ZW50L2NvbnRleHQtbWVudS1ldmVudC5zZXJ2aWNlJztcbmltcG9ydCB7IENvbnRleHRNZW51U3RhY2tTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvY29udGV4dC1tZW51LXN0YWNrL2NvbnRleHQtbWVudS1zdGFjay5zZXJ2aWNlJztcbmltcG9ydCB7IENvbnRleHRNZW51Q29udGVudENvbXBvbmVudCB9IGZyb20gJy4uL2NvbnRleHQtbWVudS1jb250ZW50L2NvbnRleHQtbWVudS1jb250ZW50LmNvbXBvbmVudCc7XG5pbXBvcnQge1xuICBnZXRQb3NpdGlvbnNUb0FuY2hvckVsZW1lbnQsXG4gIGdldFBvc2l0aW9uc1RvWFksXG59IGZyb20gJy4vY29udGV4dC1tZW51LmNvbXBvbmVudC5oZWxwZXJzJztcbmltcG9ydCB7XG4gIENvbnRleHRNZW51T3BlbkV2ZW50LFxuICBJQ29udGV4dE1lbnVDb250ZXh0LFxufSBmcm9tICcuL2NvbnRleHQtbWVudS5jb21wb25lbnQuaW50ZXJmYWNlJztcblxuQENvbXBvbmVudCh7XG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gIHNlbGVjdG9yOiAnY29udGV4dC1tZW51JyxcbiAgdGVtcGxhdGU6ICcnLFxufSlcbmV4cG9ydCBjbGFzcyBDb250ZXh0TWVudUNvbXBvbmVudDxUPiBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIC8qKlxuICAgKiBBIENTUyBjbGFzcyB0byBhcHBseSB0byB0aGUgY29udGV4dCBtZW51IG92ZXJsYXksIGlkZWFsIGZvciB0aGVtaW5nIGFuZCBjdXN0b20gc3R5bGluZ1xuICAgKi9cbiAgQElucHV0KClcbiAgcHVibGljIG1lbnVDbGFzcyA9ICcnO1xuXG4gIC8qKlxuICAgKiBEaXNhYmxlIHRoZSB3aG9sZSBjb250ZXh0IG1lbnVcbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBkaXNhYmxlZCA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoZSBtZW51IGlzIG9yaWVudGVkIHRvIHRoZSByaWdodCAoZGVmYXVsdDogYGx0cmApIG9yIHRvIHRoZSByaWdodCAoYHJ0bGApXG4gICAqL1xuICBASW5wdXQoKVxuICBwdWJsaWMgZGlyOiAnbHRyJyB8ICdydGwnIHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBFbWl0IHdoZW4gdGhlIG1lbnUgaXMgb3BlbmVkXG4gICAqL1xuICBAT3V0cHV0KClcbiAgcHVibGljIG9wZW46IEV2ZW50RW1pdHRlcjxDb250ZXh0TWVudU9wZW5FdmVudDxUPj4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgLyoqXG4gICAqIEVtaXQgd2hlbiB0aGUgbWVudSBpcyBjbG9zZWRcbiAgICovXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgY2xvc2U6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAvKipcbiAgICogVGhlIG1lbnUgaXRlbSBkaXJlY3RpdmVzIGRlZmluZWQgaW5zaWRlIHRoZSBjb21wb25lbnRcbiAgICovXG4gIEBDb250ZW50Q2hpbGRyZW4oQ29udGV4dE1lbnVJdGVtRGlyZWN0aXZlKVxuICBwdWJsaWMgbWVudUl0ZW1zITogUXVlcnlMaXN0PENvbnRleHRNZW51SXRlbURpcmVjdGl2ZTxUPj47XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIHZpc2libGVNZW51SXRlbXM6IENvbnRleHRNZW51SXRlbURpcmVjdGl2ZTxUPltdID0gW107XG4gIC8qKlxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIHB1YmxpYyB2YWx1ZT86IFQ7XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG92ZXJsYXk6IE92ZXJsYXksXG4gICAgcHJpdmF0ZSBzY3JvbGxTdHJhdGVneTogU2Nyb2xsU3RyYXRlZ3lPcHRpb25zLFxuICAgIHByaXZhdGUgY29udGV4dE1lbnVTdGFjazogQ29udGV4dE1lbnVTdGFja1NlcnZpY2U8VD4sXG4gICAgcHJpdmF0ZSBjb250ZXh0TWVudUV2ZW50U2VydmljZTogQ29udGV4dE1lbnVFdmVudFNlcnZpY2U8VD5cbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIHB1YmxpYyBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLmNvbnRleHRNZW51RXZlbnRTZXJ2aWNlLm9uU2hvdy5zdWJzY3JpYmUoXG4gICAgICAobWVudUV2ZW50KSA9PiB7XG4gICAgICAgIHRoaXMub25NZW51RXZlbnQobWVudUV2ZW50KTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKHN1YnNjcmlwdGlvbik7XG4gIH1cblxuICAvKipcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVuIGNvbnRleHQgbWVudVxuICAgKi9cbiAgcHVibGljIG9wZW5Db250ZXh0TWVudShjb250ZXh0OiBJQ29udGV4dE1lbnVDb250ZXh0PFQ+KSB7XG4gICAgbGV0IHBvc2l0aW9uU3RyYXRlZ3k6IEZsZXhpYmxlQ29ubmVjdGVkUG9zaXRpb25TdHJhdGVneTtcblxuICAgIGlmIChjb250ZXh0LmFuY2hvcmVkVG8gPT09ICdwb3NpdGlvbicpIHtcbiAgICAgIHBvc2l0aW9uU3RyYXRlZ3kgPSB0aGlzLm92ZXJsYXlcbiAgICAgICAgLnBvc2l0aW9uKClcbiAgICAgICAgLmZsZXhpYmxlQ29ubmVjdGVkVG8oe1xuICAgICAgICAgIHg6IGNvbnRleHQueCxcbiAgICAgICAgICB5OiBjb250ZXh0LnksXG4gICAgICAgIH0pXG4gICAgICAgIC53aXRoUG9zaXRpb25zKGdldFBvc2l0aW9uc1RvWFkoY29udGV4dC5kaXIpKTtcbiAgICAgIHRoaXMuY2xvc2VBbGxDb250ZXh0TWVudXMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgeyBhbmNob3JFbGVtZW50LCBwYXJlbnRDb250ZXh0TWVudSB9ID0gY29udGV4dDtcbiAgICAgIHBvc2l0aW9uU3RyYXRlZ3kgPSB0aGlzLm92ZXJsYXlcbiAgICAgICAgLnBvc2l0aW9uKClcbiAgICAgICAgLmZsZXhpYmxlQ29ubmVjdGVkVG8obmV3IEVsZW1lbnRSZWYoYW5jaG9yRWxlbWVudCkpXG4gICAgICAgIC53aXRoUG9zaXRpb25zKGdldFBvc2l0aW9uc1RvQW5jaG9yRWxlbWVudChwYXJlbnRDb250ZXh0TWVudS5kaXIpKTtcbiAgICAgIHRoaXMuY29udGV4dE1lbnVTdGFjay5kZXN0cm95U3ViTWVudXMocGFyZW50Q29udGV4dE1lbnUpO1xuICAgIH1cblxuICAgIGNvbnN0IG92ZXJsYXlSZWYgPSB0aGlzLm92ZXJsYXkuY3JlYXRlKHtcbiAgICAgIHBvc2l0aW9uU3RyYXRlZ3ksXG4gICAgICBwYW5lbENsYXNzOiAnbmd4LWNvbnRleHRtZW51JyxcbiAgICAgIHNjcm9sbFN0cmF0ZWd5OiB0aGlzLnNjcm9sbFN0cmF0ZWd5LmNsb3NlKCksXG4gICAgfSk7XG4gICAgdGhpcy5hdHRhY2hDb250ZXh0TWVudShvdmVybGF5UmVmLCBjb250ZXh0KTtcbiAgfVxuXG4gIHByaXZhdGUgb25NZW51RXZlbnQoZXZlbnQ6IENvbnRleHRNZW51T3BlbkV2ZW50PFQ+KTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IGNvbnRleHRNZW51LCB2YWx1ZSB9ID0gZXZlbnQ7XG5cbiAgICBpZiAoY29udGV4dE1lbnUgJiYgY29udGV4dE1lbnUgIT09IHRoaXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG4gICAgdGhpcy5zZXRWaXNpYmxlTWVudUl0ZW1zKCk7XG5cbiAgICB0aGlzLm9wZW5Db250ZXh0TWVudSh7XG4gICAgICAuLi5ldmVudCxcbiAgICAgIG1lbnVJdGVtRGlyZWN0aXZlczogdGhpcy52aXNpYmxlTWVudUl0ZW1zLFxuICAgICAgbWVudUNsYXNzOiB0aGlzLm1lbnVDbGFzcyxcbiAgICAgIGRpcjogdGhpcy5kaXIsXG4gICAgfSk7XG5cbiAgICB0aGlzLm9wZW4ubmV4dChldmVudCk7XG4gIH1cblxuICBwcml2YXRlIGF0dGFjaENvbnRleHRNZW51KFxuICAgIG92ZXJsYXlSZWY6IE92ZXJsYXlSZWYsXG4gICAgY29udGV4dDogSUNvbnRleHRNZW51Q29udGV4dDxUPlxuICApOiB2b2lkIHtcbiAgICBjb25zdCB7IHZhbHVlLCBtZW51SXRlbURpcmVjdGl2ZXMgfSA9IGNvbnRleHQ7XG4gICAgY29uc3QgY29udGV4dE1lbnVDb250ZW50UmVmID0gb3ZlcmxheVJlZi5hdHRhY2goXG4gICAgICBuZXcgQ29tcG9uZW50UG9ydGFsPENvbnRleHRNZW51Q29udGVudENvbXBvbmVudDxUPj4oXG4gICAgICAgIENvbnRleHRNZW51Q29udGVudENvbXBvbmVudFxuICAgICAgKVxuICAgICk7XG5cbiAgICBjb25zdCB7IGluc3RhbmNlOiBjb250ZXh0TWVudUNvbnRlbnRDb21wb25lbnQgfSA9IGNvbnRleHRNZW51Q29udGVudFJlZjtcblxuICAgIGNvbnRleHRNZW51Q29udGVudENvbXBvbmVudC52YWx1ZSA9IHZhbHVlO1xuICAgIGNvbnRleHRNZW51Q29udGVudENvbXBvbmVudC5tZW51RGlyZWN0aXZlcyA9IG1lbnVJdGVtRGlyZWN0aXZlcztcbiAgICBjb250ZXh0TWVudUNvbnRlbnRDb21wb25lbnQub3ZlcmxheVJlZiA9IG92ZXJsYXlSZWY7XG4gICAgY29udGV4dE1lbnVDb250ZW50Q29tcG9uZW50LmlzTGVhZiA9IHRydWU7XG4gICAgY29udGV4dE1lbnVDb250ZW50Q29tcG9uZW50Lm1lbnVDbGFzcyA9IHRoaXMuZ2V0TWVudUNsYXNzKGNvbnRleHQpO1xuICAgIGNvbnRleHRNZW51Q29udGVudENvbXBvbmVudC5kaXIgPSB0aGlzLmdldERpcihjb250ZXh0KTtcblxuICAgIHRoaXMuY29udGV4dE1lbnVTdGFjay5wdXNoKHtcbiAgICAgIG92ZXJsYXlSZWYsXG4gICAgICBjb250ZXh0TWVudUNvbnRlbnRDb21wb25lbnQsXG4gICAgfSk7XG5cbiAgICBjb25zdCBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG4gICAgc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICBjb250ZXh0TWVudUNvbnRlbnRDb21wb25lbnQuZXhlY3V0ZS5zdWJzY3JpYmUoKCkgPT5cbiAgICAgICAgdGhpcy5jbG9zZUFsbENvbnRleHRNZW51cygpXG4gICAgICApXG4gICAgKTtcbiAgICBzdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIGNvbnRleHRNZW51Q29udGVudENvbXBvbmVudC5jbG9zZUFsbE1lbnVzLnN1YnNjcmliZSgoKSA9PlxuICAgICAgICB0aGlzLmNsb3NlQWxsQ29udGV4dE1lbnVzKClcbiAgICAgIClcbiAgICApO1xuICAgIHN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgY29udGV4dE1lbnVDb250ZW50Q29tcG9uZW50LmNsb3NlTGVhZk1lbnUuc3Vic2NyaWJlKFxuICAgICAgICAoY2xvc2VMZWFmTWVudUV2ZW50KSA9PlxuICAgICAgICAgIHRoaXMuZGVzdHJveUxlYWZNZW51KCEhY2xvc2VMZWFmTWVudUV2ZW50LmV4Y2x1ZGVSb290TWVudSlcbiAgICAgIClcbiAgICApO1xuICAgIHN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgY29udGV4dE1lbnVDb250ZW50Q29tcG9uZW50Lm9wZW5TdWJNZW51LnN1YnNjcmliZShcbiAgICAgICAgKG9wZW5TdWJNZW51RXZlbnQ6IENvbnRleHRNZW51T3BlbkV2ZW50PFQ+KSA9PiB7XG4gICAgICAgICAgdGhpcy5jb250ZXh0TWVudVN0YWNrLmRlc3Ryb3lTdWJNZW51cyhjb250ZXh0TWVudUNvbnRlbnRDb21wb25lbnQpO1xuICAgICAgICAgIGlmICghb3BlblN1Yk1lbnVFdmVudC5jb250ZXh0TWVudSkge1xuICAgICAgICAgICAgY29udGV4dE1lbnVDb250ZW50Q29tcG9uZW50LmlzTGVhZiA9IHRydWU7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnRleHRNZW51Q29udGVudENvbXBvbmVudC5pc0xlYWYgPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLmNvbnRleHRNZW51RXZlbnRTZXJ2aWNlLnNob3cob3BlblN1Yk1lbnVFdmVudCk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICAgIHN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgY29udGV4dE1lbnVDb250ZW50Q29tcG9uZW50LmNsb3NlU3ViTWVudXMuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgdGhpcy5jb250ZXh0TWVudVN0YWNrLmRlc3Ryb3lTdWJNZW51cyhjb250ZXh0TWVudUNvbnRlbnRDb21wb25lbnQpO1xuICAgICAgfSlcbiAgICApO1xuICAgIGNvbnRleHRNZW51Q29udGVudFJlZi5vbkRlc3Ryb3koKCkgPT4ge1xuICAgICAgdGhpcy5jbG9zZS5uZXh0KCk7XG4gICAgICBtZW51SXRlbURpcmVjdGl2ZXMuZm9yRWFjaCgobWVudUl0ZW0pID0+IChtZW51SXRlbS5pc0FjdGl2ZSA9IGZhbHNlKSk7XG4gICAgICBzdWJzY3JpcHRpb25zLnVuc3Vic2NyaWJlKCk7XG4gICAgfSk7XG4gICAgY29udGV4dE1lbnVDb250ZW50UmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TWVudUNsYXNzKGV2ZW50OiBJQ29udGV4dE1lbnVDb250ZXh0PFQ+KTogc3RyaW5nIHtcbiAgICByZXR1cm4gKFxuICAgICAgZXZlbnQubWVudUNsYXNzIHx8XG4gICAgICAoZXZlbnQuYW5jaG9yZWRUbyA9PT0gJ2VsZW1lbnQnICYmIGV2ZW50Py5wYXJlbnRDb250ZXh0TWVudT8ubWVudUNsYXNzKSB8fFxuICAgICAgJydcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREaXIoZXZlbnQ6IElDb250ZXh0TWVudUNvbnRleHQ8VD4pOiAnbHRyJyB8ICdydGwnIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gKFxuICAgICAgZXZlbnQuZGlyIHx8XG4gICAgICAoZXZlbnQuYW5jaG9yZWRUbyA9PT0gJ2VsZW1lbnQnICYmIGV2ZW50Py5wYXJlbnRDb250ZXh0TWVudT8uZGlyKSB8fFxuICAgICAgdW5kZWZpbmVkXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xvc2VBbGxDb250ZXh0TWVudXMoKTogdm9pZCB7XG4gICAgdGhpcy5jb250ZXh0TWVudVN0YWNrLmNsb3NlQWxsKCk7XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lMZWFmTWVudShleGNsdWRlUm9vdE1lbnU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLmNvbnRleHRNZW51U3RhY2suY2xvc2VMZWFmTWVudShleGNsdWRlUm9vdE1lbnUpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc01lbnVJdGVtVmlzaWJsZShtZW51SXRlbTogQ29udGV4dE1lbnVJdGVtRGlyZWN0aXZlPFQ+KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGV2YWx1YXRlSWZGdW5jdGlvbihtZW51SXRlbS52aXNpYmxlLCB0aGlzLnZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0VmlzaWJsZU1lbnVJdGVtcygpOiB2b2lkIHtcbiAgICB0aGlzLnZpc2libGVNZW51SXRlbXMgPSB0aGlzLm1lbnVJdGVtcy5maWx0ZXIoKG1lbnVJdGVtKSA9PlxuICAgICAgdGhpcy5pc01lbnVJdGVtVmlzaWJsZShtZW51SXRlbSlcbiAgICApO1xuICB9XG59XG4iXX0=